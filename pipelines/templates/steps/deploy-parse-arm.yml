parameters:
  - name: displayName
  - name: azureSubscription
  - name: resourceGroupName
  - name: location
  - name: overrideParameters
  - name: armFile
  - name: deploymentName
    default: ''


steps:
  - task: AzureCLI@2
    name: getObjectId
    displayName: Get SP ID
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        objectId=$(az ad sp show \
          --id $(az account show --query "user.name" -o tsv) \
          --query "objectId" -o tsv)
        echo "##vso[task.setvariable variable=objectId;isOutput=true]$objectId"

  - task: AzureResourceGroupDeployment@2
    displayName: ${{ parameters.displayName }}
    inputs:
      action: Create Or Update Resource Group
      azureSubscription: ${{ parameters.azureSubscription }}
      resourceGroupName: ${{ parameters.resourceGroupName }}
      location: ${{ parameters.location }}
      overrideParameters: >
        ${{ parameters.overrideParameters }}
        -spid $(getObjectId.objectId)
      deploymentMode: Incremental
      templateLocation: Linked artifact
      csmFile: ${{ parameters.armFile }}
      deploymentOutputs: armOutput
      deploymentName: ${{ parameters.deploymentName }}

  - bash: |
      for key in $(echo $output | jq -r 'keys[]'); do
        echo "Found Key: $key"
        echo "Use in same job: \$(outputVars.$key)"
        echo "Use in dependent job:\
          \$[dependencies.EphemeralDeploy.outputs['outputVars.$key']"
        echo "Use in dependent stage:\
          \$[stageDependencies.EphemeralDeploy.outputs['outputVars.$key]"
        value=$(echo $output | jq -r ".$key.value")
        echo "##vso[task.setvariable variable=$key;$varSettings]$value"
      done
    name: outputVars
    displayName: Parse ARM outputs
    env:
      output: $(armOutput)
      varSettings: isOutput=true;isSecret=true
