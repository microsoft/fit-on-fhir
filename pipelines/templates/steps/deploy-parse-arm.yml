parameters:
  - name: displayName
  - name: azureSubscription
  - name: resourceGroupName
  - name: location
  - name: overrideParameters
  - name: armFile
  - name: name
    default: deploy
  - name: deploymentName
    default: ''


steps:
  - task: AzureResourceGroupDeployment@2
    displayName: ${{ parameters.displayName }}
    inputs:
      action: Create Or Update Resource Group
      azureSubscription: ${{ parameters.azureSubscription }}
      resourceGroupName: ${{ parameters.resourceGroupName }}
      location: ${{ parameters.location }}
      overrideParameters: >
        ${{ parameters.overrideParameters }}
        -spid $servicePrincipalId
      deploymentMode: Incremental
      templateLocation: Linked artifact
      csmFile: ${{ parameters.armFile }}
      deploymentOutputs: armOutput
      deploymentName: ${{ parameters.deploymentName }}
      addSpnToEnvironment: true

  - bash: |
      for key in $(echo $output | jq -r 'keys[]'); do
        echo "Found Key: $key"
        value=$(echo $output | jq -r ".$key.value")
        echo "##vso[task.setvariable variable=$key; isOutput=true]$value"
      done
    name: deploy
    displayName: Parse ARM outputs
    env:
      output: $(armOutput)
